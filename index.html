<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meine Bibliothek</title>
    <link rel="icon" href="favicon.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
    />

    <style>
      /* --- BASIS: Farben, Layout, Schrift --- */
      body {
        background-color: #121212;
        /* --- dunkelbraun --- */
        color: #e0e0e0;
        /* --- grau --- */
        font-family: "Roboto", sans-serif;
        margin: 2rem;
        font-size: 0.9rem;
      }

      h1,
      h3 {
        text-align: center;
        color: #ffffff;
      }

      /* Modus umschalten (Animation) */
      body {
        transition: background-color 1s ease, color 1.8s ease;
      }

      #library,
      .book,
      .book img {
        transition: all 0.4s ease;
      }

      .book {
        transition: padding 0.3s ease, width 0.3s ease, gap 1.8s ease;
      }

      .book img {
        transition: width 1.3s ease, height 1.3s ease;
      }

      /* 1. Buttonreihe */
      #controls,
      #filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        justify-content: center;
      }

      button,
      select,
      input[type="text"],
      textarea {
        background-color: #1e1e1e;
        color: #e0e0e0;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 0.5rem 1rem;
      }

      /* Kompaktansicht */
      body.compact-view #library {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.8rem;
      }

      body.compact-view .book {
        padding: 0.3rem;
        margin: 0;
        width: 100%;
      }

      body.compact-view .book img {
        width: 80px;
        height: 110px;
      }

      /* Nur Titel + Autor Kompaktansicht */
      body.compact-view .book-info > :not(.highlight-block) {
        display: none;
      }

      /* Rahmen um Titel + Autor */
      body.compact-view .book-title {
        font-weight: 600;
        font-size: 0.8rem;
        margin: 0.2rem 0;
      }

      body.compact-view .highlight-block .book-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
      }

      body.compact-view .highlight-block .author {
        font-size: 0.85rem;
        font-style: italic;
        color: #888;
        margin-bottom: 0.3rem;
      }

      /* Standardansicht (Detailansicht) */
      #library {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 0.3rem;
      }

      .book {
        background: #1e1e1e;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .book img {
        width: 110px;
        height: 160px;
        object-fit: contain;
        border-radius: 5px;
        box-shadow: 8px 0 8px rgba(0, 0, 0, 3.5);
      }

      .book-info {
        width: 100%;
        text-align: center;
      }

      .stars-display {
        color: #fbc02d;
        font-size: 1.2rem;
        margin-top: 0.3rem;
        text-align: center;
      }

      .tag {
        display: inline-block;
        background-color: #333;
        color: #e0e0e0;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
        margin: 0.1rem;
      }

      .book-info .highlight-block {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 0.3rem 0.5rem 0.1rem;
        border-radius: 5px;
        margin-bottom: 0.3rem;
      }

      .book-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
      }

      .book-subtitle {
        font-size: 0.75rem;
        font-weight: normal;
        color: #aaa;
        margin-top: 0.2rem;
      }

      body.light-mode .book-subtitle {
        color: #555;
      }

      .book-info .author {
        font-style: italic;
        font-weight: 500;
        margin-top: 0.2rem;
        margin-bottom: 0.2rem;
        color: #bbb;
      }

      body.light-mode .book-info .highlight-block {
        background-color: rgba(185, 131, 0, 0.2);
      }

      body.light-mode .book-info .author {
        color: #444;
      }

      /* --- FILTER & SUCHFELD --- */
      .filter-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.3rem;
        margin-bottom: 1rem;
      }

      #filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        justify-content: center;
      }

      .filter-buttons {
        display: flex;
        gap: 0.5rem;
      }

      #search-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #search-input {
        width: 150px;
        background-color: #1e1e1e;
        color: #e0e0e0;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 0.5rem;
      }

      #search-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 8px #007bff;
        background-color: #1a1a1a;
      }

      #clear-search {
        margin-left: -20px;
        cursor: pointer;
        color: #888;
      }

      #category-list li.active {
        background-color: #403e3d;
        color: white;
        font-weight: normal;
        border-radius: 4px;
      }

      body.light-mode #category-list li.active {
        background-color: #c28f49;
        color: white;
      }

      /* --- DIALOG / FORMULAR --- */
      dialog {
        background: #1e1e1e;
        color: #e0e0e0;
        border: none;
        border-radius: 8px;
        padding: 1rem;
      }

      #edit-dialog form {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        min-width: 500px;
        margin: auto;
      }

      #edit-dialog label {
        display: flex;
        flex-direction: column;
        font-size: 0.9rem;
        padding: 0.3rem 0.5rem;
        box-sizing: border-box;
      }

      #edit-dialog input[type="text"],
      #edit-dialog textarea,
      #edit-dialog select {
        width: 100%;
        padding: 0.4rem;
        background-color: #1e1e1e;
        color: #e0e0e0;
        border: 1px solid #333;
        border-radius: 5px;
        box-sizing: border-box;
      }

      #edit-dialog menu {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .checkbox-inline {
        display: flex;
        align-items: center;
        gap: 0.1rem;
      }

      .rating-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .stars {
        display: flex;
        gap: 0.3rem;
        cursor: pointer;
        font-size: 1.3rem;
      }

      .stars span {
        color: #888;
        transition: color 0.2s;
      }

      .stars span.active {
        color: gold;
      }

      /* --- MODALE FENSTER --- */
      .modal.hidden {
        display: none;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .modal-content {
        background-color: #1e1e1e;
        color: #e0e0e0;
        padding: 1.5rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-content label {
        display: block;
        margin-bottom: 0.5rem;
      }

      .modal-content input[type="checkbox"] {
        margin-right: 0.5rem;
      }

      .modal-content button {
        margin-top: 1rem;
      }

      .modal-content ul {
        list-style: none;
        padding: 0;
      }

      .modal-content ul li {
        padding: 0.3rem;
        cursor: pointer;
      }

      /* --- Heller Modus --- */
      body.light-mode {
        background-color: #f8f1e4;
        color: #2e2e2e;
      }

      body.light-mode h3 {
        color: #3b2f1c;
      }

      body.light-mode .book {
        background-color: #f5e6c1;
        color: #2e2e2e;
        box-shadow: 10px 10px 10px rgba(160, 120, 60, 0.2);
        border: 1px solid #caa66a;
      }

      body.light-mode .book-info,
      body.light-mode .details {
        color: #2e2e2e;
      }

      body.light-mode .modal-content,
      body.light-mode dialog,
      body.light-mode input,
      body.light-mode textarea,
      body.light-mode select,
      body.light-mode button {
        background-color: #f5e6c5;
        color: #2e2e2e;
        border: 1px solid #caa66a;
      }

      body.light-mode input[type="text"],
      body.light-mode textarea {
        background-color: #fffaf0;
        color: #2e2e2e;
      }

      body.light-mode #search-input {
        background-color: #f5e6c1;
        color: #2e2e2e;
        border: 1px solid #caa66a;
      }

      body.light-mode #search-input:focus {
        border-color: #c28f49;
        box-shadow: 0 0 8px #c28f49;
        background-color: #fff3dd;
      }

      body.light-mode .filter-bar button.active,
      body.light-mode #filters button.active {
        background-color: #c28f49;
        color: white;
      }

      body.light-mode .toggle-button.open {
        background-color: #c28f49;
      }

      body.light-mode #edit-dialog label {
        padding: 0.3rem 0.5rem;
      }

      body.light-mode #edit-dialog input[type="text"],
      body.light-mode #edit-dialog textarea,
      body.light-mode #edit-dialog select {
        background-color: #fffaf0;
        color: #2e2e2e;
        border: 1px solid #caa66a;
      }

      body.light-mode .stars-display {
        color: #c28f00;
      }

      body.light-mode .stars span.active {
        color: #f5a527;
      }

      /* Hover */
      @media (hover: hover) and (pointer: fine) {
        button:hover,
        select:hover,
        input[type="text"]:hover,
        textarea:hover {
          background-color: #333;
        }

        body.light-mode button:hover {
          background-color: #c28f49;
          color: #2e2e2e;
        }
      }

      /* Wrapper f√ºr Umschalter oben */
      #top-buttons {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10000;
      }

      /* Gemeinsames Styling */
      #top-buttons button {
        font-size: 0.8rem;
        border: none;
        border-radius: 20px;
        padding: 0.3rem 1rem;
        cursor: pointer;
      }

      /* Dunkelmodus Umschalter */
      body.dark-mode #top-buttons button {
        background-color: #333;
        color: #fff;
      }

      /* Hellmodus Umschalter */
      body.light-mode #top-buttons button {
        background-color: #f5e6c1;
        color: #2e2e2e;
      }

      body.light-mode #top-buttons button:hover {
        background-color: #c28f49;
        color: #2e2e2e;
      }

      /* --- Benachrichtung --*/
      #toast {
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 0.8rem 1.2rem;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      #toast.show {
        opacity: 1;
        pointer-events: auto;
      }

      /* --- Umschalter Genre --*/
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .toggle-label {
        font-size: 0.9em;
        color: var(--text-color);
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        border-radius: 24px;
        transition: 0.4s;
      }

      .slider:before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.4s;
      }

      .toggle-switch input:checked + .slider {
        background-color: var(--accent-color, #4caf50);
      }

      .toggle-switch input:checked + .slider:before {
        transform: translateX(22px);
      }

      /* Einheitlicher Stil f√ºr aktive Buttons */
      button.active {
        background-color: #403e3d;
        color: white;
        font-weight: normal;
      }

      body.light-mode button.active {
        background-color: #c28f49;
        color: white;
        font-weight: normal;
      }
    </style>
  </head>

  <body>
    <h3>üìö Meine Bibliothek</h3>
    <div
      id="read-counter"
      style="text-align: center; margin-bottom: 1rem; font-size: 0.9rem"
    ></div>

    <div id="top-buttons">
      <button id="viewToggleBtn" onclick="toggleViewMode()">üîΩ</button>
      <button id="mode-toggle" onclick="toggleMode()">üåô</button>
    </div>

    <div id="controls">
      <button onclick="addBookByISBN()">üîé Per ISBN hinzuf√ºgen</button>
      <button onclick="openImport()">üì• Epub importieren</button>
      <button onclick="newBookEntry()">‚ûï Neuer Eintrag</button>
      <button onclick="saveLibrary()">üíæ Bibliothek speichern</button>
      <button onclick="openLoadLibrary()">üìÇ Bibliothek laden</button>
      <input type="file" id="file-input" accept=".epub" multiple hidden />
      <input type="file" id="load-file" accept=".json" hidden />
    </div>

    <!-- Filter Gelesen | Neu, Kategorie, Genre, Zuletzt hinzugef√ºgt -->
    <div id="filters" class="filter-toolbar">
      <div class="filter-group">
        <button id="read-btn" onclick="setFilterStatus('read')">
          üìó Gelesen
        </button>
        <button id="unread-btn" onclick="setFilterStatus('unread')">
          üÜï Neu
        </button>
        <button id="latest-added-button">‚è≥ Zuletzt hinzugef√ºgt</button>
      </div>

      <div class="filter-group">
        <button id="category-button" onclick="openCategorySelector()">
          Kategorie filtern
        </button>
        <button id="genre-button" onclick="openGenreSelector()">
          Genre filtern
        </button>
      </div>

      <div id="search-wrapper">
        <input type="text" id="search-input" placeholder="Suche..." />
        <span id="clear-search" onclick="clearSearch()" style="display: none"
          >&times;</span
        >
      </div>
    </div>

    <!-- Filterleiste A-Z -->
    <div class="filter-bar" id="filter-bar"></div>

    <!-- Modal zur Kategorieauswahl -->
    <div id="category-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Kategorie ausw√§hlen</h3>
        <ul id="category-list"></ul>
        <button onclick="closeCategorySelector()">Abbrechen</button>
      </div>
    </div>

    <!-- Modal zur Genre-Auswahl -->
    <div id="genre-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Genres ausw√§hlen</h3>
        <form id="genre-form"></form>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="genreMatchToggle" />
            <span class="slider"></span>
          </label>
          <span class="toggle-label"
            >Alle gew√§hlten Genres m√ºssen enthalten sein</span
          >
        </div>
        <button onclick="applyGenreSelection()">OK</button>
        <button onclick="closeGenreSelector()" type="button">Abbrechen</button>
      </div>
    </div>

    <!-- Paginierung B√ºcher pro Seite -->
    <div id="library"></div>
    <div
      id="pagination-controls"
      style="
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
      "
    >
      <label for="booksPerPage">B√ºcher pro Seite:</label>
      <select id="booksPerPage" onchange="changeBooksPerPage(event)">
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="150">150</option>
        <option value="200">200</option>
        <option value="250">250</option>
      </select>
      <div id="pagination-buttons"></div>
    </div>

    <!-- Formular f√ºr Buch hinzuf√ºgen/bearbeiten -->
    <dialog id="edit-dialog">
      <form method="dialog" id="edit-form">
        <h3>Buch bearbeiten oder hinzuf√ºgen</h3>
        <input type="hidden" id="edit-index" />

        <label
          >Titel:
          <input type="text" id="edit-title" required />
        </label>

        <label
          >Untertitel:
          <input type="text" id="edit-subtitle" />
        </label>

        <label
          >Autor(en) (Nachname, Vorname ‚Äì Semikolon-getrennt):
          <input type="text" id="edit-authors" required />
        </label>

        <div style="display: flex; gap: 1rem">
          <label style="flex: 1"
            >Serie:
            <input type="text" id="edit-series" />
          </label>
          <label style="width: 12ch"
            >Band:
            <input type="text" id="edit-volume" style="width: 100%" />
          </label>
        </div>

        <div style="display: flex; gap: 1rem">
          <label style="flex: 1"
            >Ver√∂ffentlicht:
            <input type="text" id="edit-publishedDate" />
          </label>
          <label style="flex: 1"
            >ISBN:
            <input type="text" id="edit-isbn" />
          </label>
        </div>

        <div style="display: flex; gap: 1rem">
          <label style="flex: 1"
            >Kategorie:
            <input type="text" id="edit-category" list="categorySuggestions" />
          </label>
          <label style="flex: 1"
            >Genre:
            <input type="text" id="edit-genre" list="genreSuggestions" />
          </label>
        </div>

        <label
          >Beschreibung:
          <textarea id="edit-description" rows="8"></textarea>
        </label>

        <div style="display: flex; gap: 1rem">
          <label style="width: 12ch"
            >Seitenzahl:
            <input type="text" id="edit-pageCount" style="width: 100%" />
          </label>
          <label style="flex: 1"
            >Cover-URL:
            <input type="text" id="edit-thumbnail" />
          </label>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
          "
        >
          <div class="checkbox-inline">
            <input type="checkbox" id="edit-read" />
            <label for="edit-read">üìó Gelesen</label>
          </div>
          <div
            class="rating-wrapper"
            style="display: flex; align-items: center; gap: 0.5rem"
          >
            <span>Bewertung:</span>
            <div
              id="edit-rating"
              class="stars"
              data-value="0"
              style="display: flex; gap: 0.3rem; font-size: 1.3rem"
            >
              <span data-star="1">‚òÜ</span>
              <span data-star="2">‚òÜ</span>
              <span data-star="3">‚òÜ</span>
              <span data-star="4">‚òÜ</span>
              <span data-star="5">‚òÜ</span>
            </div>
          </div>
        </div>

        <label
          >Schlagw√∂rter (kommagetrennt):
          <input
            type="text"
            id="edit-tags"
            placeholder="‚Ä¶ werden in ‚Ä∫Suche‚Äπ gefunden"
          />
        </label>

        <menu
          style="
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
          "
        >
          <button type="submit">üìÖ Speichern</button>
          <button
            type="reset"
            onclick="document.getElementById('edit-dialog').close()"
          >
            Abbrechen
          </button>
        </menu>
      </form>
    </dialog>

    <!-- Modal f√ºr Detailanzeige -->
    <div id="detail-modal" class="modal hidden">
      <div class="modal-content" id="detail-modal-content"></div>
    </div>

    <!-- Datalist Vorschl√§ge -->
    <datalist id="categorySuggestions"></datalist>
    <datalist id="genreSuggestions"></datalist>

    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script>
      // Automatisches Laden von bibliothek.json beim Seitenstart
      document.addEventListener("DOMContentLoaded", () => {
        fetch("bibliothek.json")
          .then((response) => {
            if (!response.ok)
              throw new Error("Datei nicht gefunden oder Fehler beim Laden.");
            return response.json();
          })
          .then((data) => {
            // Hier wird der geladene JSON-Inhalt verarbeitet.
            // Ersetze ggf. "books" durch deinen Bibliotheks-Array-Namen!
            books = data;
            renderLibrary(); // Stelle sicher, dass diese Funktion existiert!
          })
          .catch((error) => {
            console.warn(
              "bibliothek.json konnte nicht automatisch geladen werden:",
              error.message
            );
          });
      });
      
          // Globale Variable Paginierung
          let currentPage = 1;
          let booksPerPage =
            parseInt(localStorage.getItem("booksPerPage"), 10) || 50;
          let showLatestAdded = false;
          let activeFilters = [];

          // Kategorie + Genre hier eintragen
          const genreMap = {
            Belletristik: [
              "Erotik",
              "Fantasy",
              "Frauen, Liebesroman",
              "Historisch",
              "Horror",
              "Humor",
              "Kinder, Jugend",
              "Klassiker",
              "Krimi & Thriller",
              "Mystery",
              "Romane & Erz√§hlungen",
              "Science Fiction",
            ],
            Ratgeber: [
              "Beruf",
              "Freizeit",
              "Gesundheit & Medizin",
              "Lebensf√ºhrung",
              "Sport",
              "Wirtschaft",
            ],
            Sachbuch: [
              "Biografien & Erinnerungen",
              "Geschichte",
              "Gesundheit & Medizin",
              "Kunst",
              "Mathematik",
              "Naturwissenschaft",
              "Philosophie",
              "Politik",
              "Psychologie",
              "Reisen",
              "Tiere",
            ],
          };

          // Genre 'Und' - 'Oder'
          let genreMatchMode = "any";

          // Vorschlagsliste f√ºr Kategorie im Formular bef√ºllen
          function populateCategorySuggestions() {
            const categoryList = document.getElementById("categorySuggestions");
            categoryList.innerHTML = "";

            Object.keys(genreMap).forEach((cat) => {
              const option = document.createElement("option");
              option.value = cat;
              categoryList.appendChild(option);
            });
          }

          // Beim Laden einmal aufrufen
          document.addEventListener("DOMContentLoaded", () => {
            populateCategorySuggestions();
          });

          document
            .getElementById("latest-added-button")
            .addEventListener("click", displayLatestAddedBooks);

          function displayLatestAddedBooks() {
            const latestBooks = getLatestAddedBooks();
            const libraryContainer = document.getElementById("library");
            libraryContainer.innerHTML = ""; // Leere die aktuelle Bibliotheksansicht

            const isCompactView = document.body.classList.contains("compact-view");
            const isLightMode = document.body.classList.contains("light-mode");

            if (latestBooks.length > 0) {
              latestBooks.forEach((book) => {
                const bookDiv = document.createElement("div");
                bookDiv.classList.add("book");
                if (isLightMode) {
                  bookDiv.classList.add("light-mode"); // Stelle sicher, dass der Light-Mode-Stil erhalten bleibt
                }

                let bookContent = "";
                if (isCompactView) {
                  bookContent = `
              <img src="${book.thumbnail || "no-cover.png"}" alt="${
                    book.title
                  } Cover">
              <div class="book-info">
                <div class="highlight-block">
                  <div class="book-title">${book.title}</div>
                  <div class="author">${
                    Array.isArray(book.authors)
                      ? book.authors.join(", ")
                      : book.authors
                  }</div>
                </div>
              </div>
            `;
                } else {
                  bookContent = `
              <img src="${book.thumbnail || "no-cover.png"}" alt="${
                    book.title
                  } Cover">
              <div class="book-info">
                <div class="highlight-block">
                  <div class="book-title">${book.title}</div>
                  ${
                    book.subtitle
                      ? `<div class="book-subtitle">${book.subtitle}</div>`
                      : ""
                  }
                  <div class="author">${
                    Array.isArray(book.authors)
                      ? book.authors.join(", ")
                      : book.authors
                  }</div>
                </div>
                ${
                  book.rating
                    ? `<div class="stars-display">${"‚òÖ".repeat(book.rating)}</div>`
                    : ""
                }
                ${
                  book.tags && book.tags.length > 0
                    ? book.tags
                        .map((tag) => `<span class="tag">${tag}</span>`)
                        .join("")
                    : ""
                }
              </div>
            `;
                }
                bookDiv.innerHTML = bookContent;
                libraryContainer.appendChild(bookDiv);
              });
            } else {
              libraryContainer.innerHTML =
                "<p>Keine zuletzt hinzugef√ºgten B√ºcher gefunden.</p>";
            }
          }

          // Kategoriefilter
          function filterByCategory(category) {
            const categoryBtn = document.getElementById("category-button");
            const genreBtn = document.getElementById("genre-button");

            if (selectedCategories[0] === category) {
              // Filter aufheben
              selectedCategories = [];
              categoryBtn.textContent = "Kategorie filtern";
              categoryBtn.classList.remove("active");
            } else {
              // Neue Kategorie setzen
              selectedCategories = [category];
              categoryBtn.textContent = category;
              categoryBtn.classList.add("active");
            }

            // Genre-Filter zur√ºcksetzen
            selectedGenres = [];
            genreBtn.textContent = "Genre filtern";
            genreBtn.classList.remove("active");

            currentPage = 1;

            renderLibrary();
          }

          // √ñffnet das Kategorie-Auswahlfenster
          function openCategorySelector() {
            const list = document.getElementById("category-list");
            list.innerHTML = "";
            const currentCategory = selectedCategories[0];

            Object.keys(genreMap).forEach((cat) => {
              const li = document.createElement("li");
              li.textContent = cat;

              if (cat === currentCategory) {
                li.classList.add("active");
              }

              li.onclick = () => {
                filterByCategory(cat);
                closeCategorySelector();
              };

              list.appendChild(li);
            });

            document.getElementById("category-modal").classList.remove("hidden");
          }

          // Schlie√üt das Kategorie-Auswahlfenster
          function closeCategorySelector() {
            document.getElementById("category-modal").classList.add("hidden");
          }

          // √ñffnet das Genre-Auswahlfenster mit Checkboxen
          function openGenreSelector() {
            const form = document.getElementById("genre-form");
            form.innerHTML = "";

            const selectedCategory = selectedCategories[0];
            const genres = genreMap[selectedCategory] || [];

            genres.forEach((gen) => {
              const label = document.createElement("label");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = gen;
              checkbox.name = "genre";
              checkbox.checked = selectedGenres.includes(gen);
              label.appendChild(checkbox);
              label.append(" ", gen);
              form.appendChild(label);
            });

            document.getElementById("genre-modal").classList.remove("hidden");
          }

          // Schlie√üt das Genre-Auswahlfenster
          function closeGenreSelector() {
            document.getElementById("genre-modal").classList.add("hidden");
          }

          // Wendet die Genre-Filterauswahl an
          function applyGenreSelection() {
            const form = document.getElementById("genre-form");
            const checked = [...form.elements["genre"]]
              .filter((input) => input.checked)
              .map((input) => input.value);

            selectedGenres = checked;
            const genreBtn = document.getElementById("genre-button");

            if (selectedGenres.length > 0) {
              genreBtn.textContent = selectedGenres.join(", ");
              genreBtn.classList.add("active");
            } else {
              genreBtn.textContent = "Genre filtern";
              genreBtn.classList.remove("active");
            }

            closeGenreSelector();
            currentPage = 1;
            renderLibrary();
          }

          // --- Zust√§nde ---
          let selectedCategories = [];
          let selectedGenres = [];

          (async () => {
      // API-Schl√ºssel f√ºr Google Books (ersetze DEINEN_API_SCHL√úSSEL)
      const apiKey = 'DEINEN_API_SCHL√úSSEL'; // Sicherstellen, dass dieser entfernt ist f√ºr GitHub

      let library = JSON.parse(localStorage.getItem("epubLibrary") || "[]");
      let editMode = false;
      let activeFilters = [];
      let isCreatingNew = false;
      let filterStatus = "all"; // 'all', 'read', 'unread'
      })();

          // Hilfsfunktionen
          function normalizeName(name) {
            return name
              .trim()
              .replace(/,+/g, ",")
              .replace(/\s*,\s*/g, ", ")
              .replace(/\s*;\s*/g, "; ")
              .replace(/^;+|;+$|^,+|,+$/g, "")
              .split(";")
              .map((part) => part.trim())
              .filter(Boolean)
              .join("; ");
          }

          function normalizeFirstLetter(name) {
            return normalizeName(name)
              .charAt(0)
              .toUpperCase()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "");
          }

          // Letzte hinzugef√ºgte B√ºcher
          function getLatestAddedBooks(count = 10) {
            const storedLibrary = localStorage.getItem("epubLibrary");
            if (storedLibrary) {
              try {
                const library = JSON.parse(storedLibrary);
                // Filtere B√ºcher, die ein 'addedAt'-Feld haben (f√ºr den Fall √§lterer Eintr√§ge ohne Zeitstempel)
                const booksWithTimestamp = library.filter((book) => book.addedAt);

                // Sortiere nach 'addedAt' in absteigender Reihenfolge (neueste zuerst)
                booksWithTimestamp.sort((a, b) => b.addedAt - a.addedAt);

                // Gib die ersten 'count' Eintr√§ge zur√ºck
                return booksWithTimestamp.slice(0, count);
              } catch (error) {
                console.error(
                  "Fehler beim Abrufen und Sortieren der Bibliothek:",
                  error
                );
                return [];
              }
            }
            return [];
          }

          // Beispiel, um die letzten 5 hinzugef√ºgten B√ºcher in der Konsole anzuzeigen:
          const latestBooks = getLatestAddedBooks(5);
          console.log("Die letzten hinzugef√ºgten B√ºcher:", latestBooks);

          // Dialog √∂ffnen f√ºr Dateiimport
          function openImport() {
            document.getElementById("file-input").click();
          }

          // Dialog √∂ffnen f√ºr JSON-Laden
          function openLoadLibrary() {
            document.getElementById("load-file").click();
          }

          // Suchfeld l√∂schen
          document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("search-input");
            const clearBtn = document.getElementById("clear-search");

            if (searchInput) {
              searchInput.addEventListener("input", () => {
                currentPage = 1; // <<< wichtig
                renderLibrary();
              });

              // Enter-Taste leeren
              searchInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                  event.preventDefault();
                  event.target.value = "";
                  currentPage = 1; // <<< wichtig
                  renderLibrary();
                }
              });
            }

            if (clearBtn) {
              clearBtn.addEventListener("click", () => {
                searchInput.value = "";
                currentPage = 1; // <<< wichtig
                renderLibrary();
              });
            }
          });

          // --- Initialisierung ---
          document.addEventListener("DOMContentLoaded", () => {
            renderFilterBar();
            renderLibrary();
          });

          // --- Filterleiste A-Z ---
          function renderFilterBar() {
            const filterBar = document.getElementById("filter-bar");
            filterBar.innerHTML = "";

            // Schaltfl√§chen f√ºr A bis W
            for (let i = 65; i <= 87; i++) {
              // ASCII f√ºr A ist 65, W ist 87
              const char = String.fromCharCode(i);
              const btn = document.createElement("button");
              btn.textContent = char;

              btn.onclick = () => {
                if (activeFilters.includes(char)) {
                  activeFilters = activeFilters.filter((l) => l !== char);
                } else {
                  activeFilters.push(char);
                }
                renderLibrary();
              };

              if (activeFilters.includes(char)) {
                btn.classList.add("active");
              }
              filterBar.appendChild(btn);
            }

            // Schaltfl√§che f√ºr X-Y-Z
            const xyzBtn = document.createElement("button");
            xyzBtn.textContent = "X-Y-Z";
            xyzBtn.onclick = () => {
              const xyzChars = ["X", "Y", "Z"];
              const allXyzActive = xyzChars.every((char) =>
                activeFilters.includes(char)
              );

              if (allXyzActive) {
                activeFilters = activeFilters.filter((l) => !xyzChars.includes(l));
              } else {
                xyzChars.forEach((char) => {
                  if (!activeFilters.includes(char)) {
                    activeFilters.push(char);
                  }
                });
              }
              renderLibrary();
            };

            // Styling der X-Y-Z Schaltfl√§che basierend auf dem Zustand der einzelnen Buchstaben
            const xyzActive = ["X", "Y", "Z"].some((char) =>
              activeFilters.includes(char)
            );
            if (xyzActive) {
              xyzBtn.classList.add("active");
            }
            filterBar.appendChild(xyzBtn);
          }

          // B√ºcher pro Seite localStorage speichern
          document.addEventListener("DOMContentLoaded", () => {
            const savedBooksPerPage = localStorage.getItem("booksPerPage");
            if (savedBooksPerPage) {
              const select = document.getElementById("booksPerPage");
              if (select) {
                select.value = savedBooksPerPage;
                booksPerPage = parseInt(savedBooksPerPage, 10);
              }
            }

            renderFilterBar();
            renderLibrary();
            renderPagination();
          });

          // Funktion zum Wechseln der Anzahl pro Seite
          function changeBooksPerPage(event) {
            const value = parseInt(event.target.value, 10);
            if (!isNaN(value)) {
              booksPerPage = value;
              currentPage = 1;
              localStorage.setItem("booksPerPage", value);
              renderLibrary();
            }
          }

          function renderLibrary() {
            renderFilterBar();
            const libraryDiv = document.getElementById("library");
            libraryDiv.innerHTML = "";
            let books = [...library];

            // --- Andere Filter anwenden (zuerst) ---
            if (selectedCategories.length > 0) {
              books = books.filter((book) =>
                selectedCategories.includes(book.category)
              );
            }

            if (selectedGenres.length > 0) {
              books = books.filter((book) => {
                const bookGenres = (book.genre || "")
                  .split(";")
                  .map((g) => g.trim().toLowerCase());
                const selected = selectedGenres.map((g) => g.toLowerCase());
                return genreMatchMode === "all"
                  ? selected.every((sel) => bookGenres.includes(sel))
                  : selected.some((sel) => bookGenres.includes(sel));
              });
            }

            const searchTerm = document
              .getElementById("search-input")
              .value.trim()
              .toLowerCase();
            if (searchTerm) {
              const normalizedSearchTermForIsbn = searchTerm.replace(/[-\s]/g, "");
              books = books.filter(
                (book) =>
                  (book.title || "").toLowerCase().includes(searchTerm) ||
                  (book.authors || [])
                    .join("; ")
                    .toLowerCase()
                    .includes(searchTerm) ||
                  (book.series || "").toLowerCase().includes(searchTerm) ||
                  (book.isbn || "")
                    .toLowerCase()
                    .replace(/[-\s]/g, "")
                    .includes(normalizedSearchTermForIsbn) ||
                  (book.tags || []).some((tag) =>
                    tag.toLowerCase().includes(searchTerm)
                  )
              );
            }

            if (filterStatus === "read") {
              books = books.filter((book) => book.read === true);
            } else if (filterStatus === "unread") {
              books = books.filter((book) => book.read !== true);
            }

            if (activeFilters.length > 0) {
              books = books.filter((book) =>
                (book.authors || []).some((author) =>
                  activeFilters.includes(normalizeFirstLetter(author))
                )
              );
            }

            // --- "Zuletzt hinzugef√ºgt"-Filter (nach den anderen Filtern) ---
            if (showLatestAdded && books.length > 0) {
              const withTimestamp = books.filter(
                (book) => book.addedAt !== undefined
              );
              const sortedWithTimestamp = [...withTimestamp].sort(
                (a, b) => b.addedAt - a.addedAt
              );
              books = sortedWithTimestamp.slice(0, 40);
            }

            // --- Sortierung ---
            if (!showLatestAdded) {
              // Nur sortieren, wenn "Zuletzt hinzugef√ºgt" nicht aktiv ist
              books.sort((a, b) => {
                const authorA = normalizeName(a.authors?.[0] || "").toLowerCase();
                const authorB = normalizeName(b.authors?.[0] || "").toLowerCase();
                if (authorA !== authorB)
                  return authorA.localeCompare(authorB, "de");

                const hasSeriesA = !!a.series?.trim();
                const hasSeriesB = !!b.series?.trim();
                if (hasSeriesA !== hasSeriesB) return hasSeriesA ? 1 : -1;

                const seriesA = (a.series || "").toLowerCase();
                const seriesB = (b.series || "").toLowerCase();
                if (seriesA !== seriesB)
                  return seriesA.localeCompare(seriesB, "de");

                const hasVolumeA = !!a.volume;
                const hasVolumeB = !!b.volume;
                if (hasVolumeA !== hasVolumeB) return hasVolumeA ? 1 : -1;

                const volumeA = parseFloat(a.volume) || 0;
                const volumeB = parseFloat(b.volume) || 0;
                if (volumeA !== volumeB) return volumeA - volumeB;

                const titleA = (a.title || "").toLowerCase();
                const titleB = (b.title || "").toLowerCase();
                return titleA.localeCompare(titleB, "de");
              });
            } else {
              // Wenn "Zuletzt hinzugef√ºgt" aktiv ist, nach Hinzuf√ºgedatum sortieren (neueste zuerst)
              books.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
            }

            // --- Paginierung anwenden ---
            const start = (currentPage - 1) * booksPerPage;
            const end = start + booksPerPage;
            const paginatedBooks = books.slice(start, end);

            // --- Ausgabe ---
            paginatedBooks.forEach((book) => {
              const index = library.indexOf(book);
              const div = document.createElement("div");
              div.className = "book";

              div.innerHTML = `
          <img src="${
            book.thumbnail || ""
          }" alt="Cover" style="cursor:pointer" onclick="showDetailModal(library[${index}])">
          <div class="book-info">
            <div class="highlight-block">
              <div class="book-title">${book.title}</div>
              ${
                book.subtitle
                  ? `<div class="book-subtitle">${book.subtitle}</div>`
                  : ""
              }
              <div class="author">${(book.authors || [])
                .map(normalizeName)
                .join("; ")}</div>
            </div>
            ${book.series ? `<div><b>Serie:</b> ${book.series}</div>` : ""}
            ${book.volume ? `<div><b>Band:</b> ${book.volume}</div>` : ""}
            ${book.category ? `<div><b>Kategorie:</b> ${book.category}</div>` : ""}
            ${book.genre ? `<div><b>Genre:</b> ${book.genre}</div>` : ""}
            <div><b>Status:</b> <span style="color: ${
              book.read ? "#3feb57" : "#00bfff"
            };">
              ${book.read ? "üìó Gelesen" : "üÜï Ungelesen"}</span>
            </div>
            ${
              book.rating
                ? `
              <div class="stars-display" title="${book.rating} von 5 Sternen">
                ${"‚òÖ".repeat(book.rating)}${"‚òÜ".repeat(5 - book.rating)}
              </div>
            `
                : ""
            }

            <div class="book-actions">
              <button onclick="editBook(${index})">‚úèÔ∏è</button>
              <button onclick="confirmRemoveBook(${index})">üóëÔ∏è</button>
            </div>
          </div>
        `;

              libraryDiv.appendChild(div);
            });

            // --- Nach Ausgabe: Z√§hler und Seitenzahlen aktualisieren ---
            updateReadCounter();
            renderPagination(books.length);
          }

          // Hilfsfunktion Paginierung
          function renderPagination(totalBooks) {
            const totalPages = Math.ceil(totalBooks / booksPerPage);
            const container = document.getElementById("pagination-buttons");
            container.innerHTML = "";

            for (let i = 1; i <= totalPages; i++) {
              const btn = document.createElement("button");
              btn.textContent = i;
              if (i === currentPage) btn.classList.add("active");
              btn.onclick = () => {
                currentPage = i;
                renderLibrary();
                window.scrollTo({ top: 0, behavior: "smooth" });
              };
              container.appendChild(btn);
            }
          }

          // Buchbearbeitung: Neuen Eintrag erstellen
          function newBookEntry() {
            isCreatingNew = true;
            document.getElementById("edit-form").reset();
            document.getElementById("edit-index").value = "";
            document.getElementById("edit-dialog").showModal();
          }

          // Interaktive Sternebewertung (f√ºr das Formular)
          function setupStarRating() {
            const ratingDiv = document.getElementById("edit-rating");
            if (!ratingDiv) return;

            const stars = ratingDiv.querySelectorAll("span");

            stars.forEach((star) => {
              star.addEventListener("click", () => {
                const value = parseInt(star.getAttribute("data-star"));
                ratingDiv.setAttribute("data-value", value);
                updateStarDisplay(ratingDiv, value);
              });
            });
          }

          // Aktualisiert visuelle Darstellung der aktiven Sterne
          function updateStarDisplay(container, value) {
            const stars = container.querySelectorAll("span");
            stars.forEach((star) => {
              const starVal = parseInt(star.getAttribute("data-star"));
              star.classList.toggle("active", starVal <= value);
            });
          }

          function editBook(index) {
            const book = library[index];
            isCreatingNew = false;
            document.getElementById("edit-index").value = index;
            document.getElementById("edit-title").value = book.title || "";
            document.getElementById("edit-subtitle").value = book.subtitle || "";
            document.getElementById("edit-authors").value = (
              book.authors || []
            ).join("; ");
            document.getElementById("edit-series").value = book.series || "";
            document.getElementById("edit-volume").value = book.volume || "";
            document.getElementById("edit-publishedDate").value =
              book.publishedDate || "";
            document.getElementById("edit-isbn").value = book.isbn || "";
            document.getElementById("edit-category").value = book.category || "";
            document.getElementById("edit-genre").value = book.genre || "";
            document.getElementById("edit-description").value =
              book.description || "";
            document.getElementById("edit-pageCount").value = book.pageCount || "";
            document.getElementById("edit-thumbnail").value = book.thumbnail || "";
            document.getElementById("edit-read").checked = book.read || false;
            document.getElementById("edit-tags").value = (book.tags || []).join(
              ", "
            );

            // Genre-Vorschl√§ge abh√§ngig von der gew√§hlten Kategorie aktualisieren
            const selectedCategory = book.category;
            const genreList = document.getElementById("genreSuggestions");
            genreList.innerHTML = "";
            if (genreMap[selectedCategory]) {
              genreMap[selectedCategory].forEach((genre) => {
                const option = document.createElement("option");
                option.value = genre;
                genreList.appendChild(option);
              });
            }

            document.getElementById("edit-dialog").showModal();
            updateStarDisplay(
              document.getElementById("edit-rating"),
              book.rating || 0
            );
            document
              .getElementById("edit-rating")
              .setAttribute("data-value", book.rating || 0);
          }

          // --- Buch speichern (Neues oder Bearbeitetes) ---
          document.getElementById("edit-form").addEventListener("submit", () => {
            const index = document.getElementById("edit-index").value;
            const authorsRaw = document.getElementById("edit-authors").value;
            const bookDataFromForm = {
              title: document.getElementById("edit-title").value.trim(),
              subtitle: document.getElementById("edit-subtitle").value.trim(),
              authors: authorsRaw
                .split(";")
                .map((a) => normalizeName(a.trim()))
                .filter(Boolean),
              series: document.getElementById("edit-series").value.trim(),
              volume: document.getElementById("edit-volume").value.trim(),
              publishedDate: document
                .getElementById("edit-publishedDate")
                .value.trim(),
              isbn: document.getElementById("edit-isbn").value.trim(),
              category: document.getElementById("edit-category").value.trim(),
              genre: document.getElementById("edit-genre").value.trim(),
              description: document.getElementById("edit-description").value.trim(),
              pageCount: document.getElementById("edit-pageCount").value.trim(),
              thumbnail: document.getElementById("edit-thumbnail").value.trim(),
              read: document.getElementById("edit-read").checked,
              rating:
                parseInt(
                  document.getElementById("edit-rating").getAttribute("data-value")
                ) || null,
              tags: document
                .getElementById("edit-tags")
                .value.split(",")
                .map((tag) => tag.trim())
                .filter(Boolean),
            };

            if (index !== "" && !isCreatingNew) {
              // Bearbeiten eines bestehenden Buches
              library[+index] = { ...library[+index], ...bookDataFromForm };
            } else {
              // Hinzuf√ºgen eines neuen Buches (h√§ndisch)
              const newBook = {
                ...bookDataFromForm,
                addedAt: Date.now(), // Zeitstempel f√ºr neue B√ºcher
              };
              library.push(newBook);
            }

            localStorage.setItem("epubLibrary", JSON.stringify(library));
            document.getElementById("edit-dialog").close();
            renderLibrary();
          });

          // --- B√ºcher aus .epub Dateien importieren ---
          async function processFile(file) {
            const zip = await JSZip.loadAsync(file);
            const container = await zip
              .file("META-INF/container.xml")
              .async("string");
            const parser = new DOMParser();
            const containerDoc = parser.parseFromString(
              container,
              "application/xml"
            );
            const rootfilePath = containerDoc
              .querySelector("rootfile")
              ?.getAttribute("full-path");
            if (!rootfilePath) return;
            const contentOpf = await zip.file(rootfilePath).async("string");
            const opfDoc = parser.parseFromString(contentOpf, "application/xml");

            let title =
              opfDoc.querySelector("metadata > title")?.textContent ||
              file.name.replace(/\.epub$/i, "");
            let authors = Array.from(
              opfDoc.querySelectorAll("metadata > creator")
            ).map((el) => el.textContent.trim());

            let rawIsbn =
              Array.from(opfDoc.querySelectorAll("metadata > identifier"))
                .map((el) => el.textContent)
                .find((id) => id.replace(/[^0-9X]/gi, "").length >= 10) || "";

            const cleanIsbn = rawIsbn.replace(/[^0-9X]/gi, "");

            if (
              library.some(
                (book) => (book.isbn || "").replace(/[^0-9X]/gi, "") === cleanIsbn
              )
            ) {
              showToast(`Buch mit ISBN ${cleanIsbn} ist bereits vorhanden!`);
              return;
            }

            const book = {
              title,
              subtitle: "",
              authors,
              isbn: cleanIsbn,
              series: "",
              volume: "",
              publishedDate: "",
              description: "",
              thumbnail: "",
              read: false,
              pageCount: "",
              addedAt: Date.now(), // Hinzuf√ºgen des Zeitstempels
            };

            // Serie und Bandnummer aus OPF lesen
            const metaTags = opfDoc.querySelectorAll("metadata > meta");
            metaTags.forEach((meta) => {
              const name = meta.getAttribute("name");
              const content = meta.getAttribute("content");
              if (name === "calibre:series") {
                book.series = content;
              } else if (name === "calibre:series_index") {
                book.volume = content;
              }
            });

            if (cleanIsbn) {
              try {
                const response = await fetch(
                  `https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}&key=${apiKey}`
                );
                const data = await response.json();
                const info = data.items?.[0]?.volumeInfo;
                if (info) {
                  const subtitle = info.subtitle?.trim();
                  book.title = info.title || book.title;
                  book.subtitle = info.subtitle?.trim() || "";
                  book.authors = info.authors
                    ? info.authors.map((author) => {
                        const parts = author.trim().split(/\s+/);
                        if (parts.length >= 2) {
                          const last = parts.pop();
                          const first = parts.join(" ");
                          return `${last}, ${first}`;
                        }
                        return author.trim();
                      })
                    : book.authors;

                  book.publishedDate = info.publishedDate || "";
                  book.description = info.description || "";
                  book.thumbnail =
                    info.imageLinks?.thumbnail?.replace("http:", "https:") || "";
                  book.pageCount = info.pageCount
                    ? info.pageCount.toString()
                    : "Unbekannt";

                  if (!book.thumbnail) {
                    console.warn(`Kein Cover f√ºr ISBN ${cleanIsbn} gefunden.`);
                  }
                } else {
                  console.warn(
                    `Keine Google Books Info f√ºr ISBN ${cleanIsbn} gefunden.`
                  );
                }
              } catch (e) {
                console.error("Fehler bei der Google API:", e);
              }
            } else {
              console.warn(
                `Keine g√ºltige ISBN in der Datei ${file.name} gefunden.`
              );
            }

            library.push(book);
            showToast(`‚Äû${book.title}‚Äú wurde importiert.`);
          }

          // --- Bibliothek als JSON-Datei speichern ---
          function saveLibrary() {
            const blob = new Blob([JSON.stringify(library, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "bibliothek_.json";
            a.click();
            URL.revokeObjectURL(url);
          }

          // --- Funktionen f√ºr Suche, Clear Button und initiales Laden ---
          function clearSearch() {
            document.getElementById("search-input").value = "";
            renderLibrary();
          }

          document.getElementById("search-input").addEventListener("input", () => {
            renderLibrary();
          });

          function openImport() {
            document.getElementById("file-input").click();
          }

          function openLoadLibrary() {
            document.getElementById("load-file").click();
          }

          document
            .getElementById("file-input")
            .addEventListener("change", async (e) => {
              const files = Array.from(e.target.files);
              for (const file of files) {
                await processFile(file);
              }
              localStorage.setItem("epubLibrary", JSON.stringify(library));
              renderLibrary();
            });

          document
            .getElementById("load-file")
            .addEventListener("change", async (e) => {
              const file = e.target.files[0];
              if (!file) return;
              const text = await file.text();
              try {
                const json = JSON.parse(text);
                if (Array.isArray(json)) {
                  library = json;
                  localStorage.setItem("epubLibrary", JSON.stringify(library));
                  renderLibrary();
                } else {
                  showToast("Ung√ºltiges Format");
                }
              } catch (err) {
                showToast("Fehler beim Laden der Datei");
              }
            });

          // Alle/Oder Genreschalter
          document
            .getElementById("genreMatchToggle")
            .addEventListener("change", function () {
              genreMatchMode = this.checked ? "all" : "any";
              renderLibrary();
            });

          // Dynamische Genre-Vorschl√§ge je nach Kategorie im Formular
          document.getElementById("edit-category").addEventListener("input", () => {
            const selectedCategory = document.getElementById("edit-category").value;
            const genreList = document.getElementById("genreSuggestions");

            // Genre-Liste leeren
            genreList.innerHTML = "";

            // Neue Vorschl√§ge je nach Kategorie aus genreMap einf√ºgen
            const genres = genreMap[selectedCategory] || [];
            genres.forEach((genre) => {
              const option = document.createElement("option");
              option.value = genre;
              genreList.appendChild(option);
            });

            // Wenn der aktuelle Genre-Wert nicht mehr zur Kategorie passt ‚Üí l√∂schen
            const currentGenre = document.getElementById("edit-genre").value;
            if (!genres.includes(currentGenre)) {
              document.getElementById("edit-genre").value = "";
            }
          });

          // Seite initial laden
          document.addEventListener("DOMContentLoaded", () => {
            renderFilterBar();
            renderLibrary();
          });

          // Zuletzt hinzugef√ºgt
          document.addEventListener("DOMContentLoaded", () => {
            const latestAddedButton = document.getElementById(
              "latest-added-button"
            );
            if (latestAddedButton) {
              latestAddedButton.addEventListener("click", () => {
                showLatestAdded = !showLatestAdded;
                renderLibrary();
                latestAddedButton.classList.toggle("active", showLatestAdded);
              });
            } else {
              console.error(
                "Der 'Zuletzt hinzugef√ºgt'-Button wurde nicht gefunden!"
              );
            }
          });

          // "X" zum L√∂schen
          document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.getElementById("search-input");
            const clearSearchSpan = document.getElementById("clear-search");

            if (searchInput && clearSearchSpan) {
              searchInput.addEventListener("input", () => {
                if (searchInput.value.trim() !== "") {
                  clearSearchSpan.style.display = "inline"; // Oder 'block', je nach Layout
                } else {
                  clearSearchSpan.style.display = "none";
                }
              });

              // Stelle sicher, dass das "X" initial versteckt ist, wenn das Suchfeld leer ist
              if (searchInput.value.trim() === "") {
                clearSearchSpan.style.display = "none";
              }
            }
          });

          function formatAuthors(authors) {
            return authors.map((name) => {
              name = name.trim();
              if (name.includes(",")) {
                const [last, first] = name.split(",").map((s) => s.trim());
                return `${last}, ${first}`;
              } else {
                const parts = name.split(/\s+/);
                if (parts.length >= 2) {
                  const firstName = parts.slice(0, -1).join(" ");
                  const lastName = parts.slice(-1)[0];
                  return `${lastName}, ${firstName}`;
                }
                return name;
              }
            });
          }

          // Per ISBN hinzuf√ºgen
          async function addBookByISBN() {
            const userInput = prompt("Bitte die ISBN eingeben:");
            if (!userInput) return; // Keine Eingabe = Abbruch

            let isbn = userInput.replace(/[^0-9Xx]/g, "").toUpperCase(); // Bereinigen

            if (isbn.length === 10) {
              isbn = convertISBN10to13(isbn);
            }

            // Pr√ºfen, ob Buch bereits vorhanden
            if (
              library.some(
                (book) => (book.isbn || "").replace(/[^0-9X]/gi, "") === isbn
              )
            ) {
              showToast("Ein Buch mit dieser ISBN ist bereits in der Bibliothek.");
              return;
            }

            try {
              const response = await fetch(
                `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`
              );
              const data = await response.json();

              if (data.totalItems === 0) {
                showToast("Kein Buch mit dieser ISBN gefunden.");
                return;
              }

              const info = data.items[0].volumeInfo;

              const book = {
                title: info.title || "Unbekannter Titel",
                subtitle: info.subtitle || "", // ‚Üê separat gespeichert
                authors: info.authors
                  ? formatAuthors(info.authors)
                  : ["Unbekannter Autor"],
                series: "",
                volume: "",
                publishedDate: info.publishedDate || "",
                isbn: isbn,
                category: "",
                genre: "",
                description: info.description || "",
                pageCount: info.pageCount ? info.pageCount.toString() : "Unbekannt",
                thumbnail:
                  info.imageLinks?.thumbnail?.replace("http:", "https:") || "",
                read: false,
                addedAt: Date.now(), // Hinzuf√ºgen des Zeitstempels
              };

              library.push(book);

              // Zeige das gerade hinzugef√ºgte Buch an (mit Zeitstempel)
              console.log("Zuletzt hinzugef√ºgtes Buch (per ISBN):", book);

              localStorage.setItem("epubLibrary", JSON.stringify(library));
              renderLibrary();
              showToast("Buch erfolgreich hinzugef√ºgt!");
            } catch (error) {
              console.error("Fehler bei der ISBN-Suche:", error);
              showToast("Es gab ein Problem beim Abrufen der Buchdaten.");
            }
          }

          // Hilfsfunktion: ISBN-10 zu ISBN-13 umwandeln
          function convertISBN10to13(isbn10) {
            const core = "978" + isbn10.substring(0, 9);
            let sum = 0;
            for (let i = 0; i < core.length; i++) {
              sum += parseInt(core[i], 10) * (i % 2 === 0 ? 1 : 3);
            }
            const checkDigit = (10 - (sum % 10)) % 10;
            return core + checkDigit;
          }

          // Hilfsfunktion: Autoren ins Format "Nachname, Vorname" umwandeln
          function formatAuthors(authors) {
            return authors.map((name) => {
              const parts = name.trim().split(" ");
              if (parts.length >= 2) {
                const lastName = parts.pop();
                const firstName = parts.join(" ");
                return `${lastName}, ${firstName}`;
              }
              return name;
            });
          }

          // Gelesen, Neu aktiv
          function setFilterStatus(status) {
            // Wenn derselbe Status nochmal geklickt wird ‚Üí zur√ºck auf "all"
            filterStatus = filterStatus === status ? "all" : status;
            renderLibrary();

            // Alle Buttons zur√ºcksetzen
            document.getElementById("read-btn").classList.remove("active");
            document.getElementById("unread-btn").classList.remove("active");

            // Aktivieren nur, wenn nicht "all"
            if (filterStatus === "read") {
              document.getElementById("read-btn").classList.add("active");
            } else if (filterStatus === "unread") {
              document.getElementById("unread-btn").classList.add("active");
            }

            // Touch-Fokus oder Hovern verhindern
            if (document.activeElement instanceof HTMLElement) {
              document.activeElement.blur();
            }
          }

          setupStarRating();

          // Buch l√∂schen
          function confirmRemoveBook(index) {
            const book = library[index];
            const title = book.title || "dieses Buch";
            if (confirm(`M√∂chtest du "${title}" wirklich l√∂schen?`)) {
              removeBook(index);
            }
          }

          function removeBook(index) {
            const book = library[index];
            const libraryDiv = document.getElementById("library");
            const bookDivs = libraryDiv.querySelectorAll(".book");
            const bookDiv = bookDivs[index];

            if (bookDiv) {
              bookDiv.classList.add("fade-out");
              setTimeout(() => {
                library.splice(index, 1);
                localStorage.setItem("epubLibrary", JSON.stringify(library));
                renderLibrary(); // Nach dem Fade-out neu rendern
              }, 500); // Zeit passend zum CSS transition delay
            } else {
              // Fallback ‚Äì falls das Buch nicht gefunden wird
              library.splice(index, 1);
              localStorage.setItem("epubLibrary", JSON.stringify(library));
              renderLibrary();
            }
          }

          // Z√§hler f√ºr gelesene B√ºcher
          function updateReadCounter() {
            const count = library.filter((book) => book.read === true).length;
            const total = library.length;
            const counter = document.getElementById("read-counter");
            if (counter) {
              counter.textContent = `üìó Gelesen: ${count} von ${total} B√ºchern`;
            }
          }

          // Umschalter Hell/Dunkel
          function toggleMode() {
            const body = document.body;
            const isLight = body.classList.toggle("light-mode");
            localStorage.setItem("library-mode", isLight ? "light" : "dark");
            document.getElementById("mode-toggle").textContent = isLight
              ? "üåû"
              : "üåô";
          }

          // Meldung
          function showToast(message, duration = 3000) {
            let toast = document.getElementById("toast");
            if (!toast) {
              toast = document.createElement("div");
              toast.id = "toast";
              document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.className = "show";
            setTimeout(() => {
              toast.className = toast.className.replace("show", "");
            }, duration);
          }

          // Kompaktansicht
          let compactViewEnabled = false;

          function toggleViewMode() {
            compactViewEnabled = !compactViewEnabled;
            const toggleButton = document.getElementById("viewToggleBtn");
            document.body.classList.toggle("compact-view", compactViewEnabled);
            toggleButton.textContent = compactViewEnabled ? "üîº" : "üîΩ";

            // Speichern des Modus
            localStorage.setItem(
              "library-view",
              compactViewEnabled ? "compact" : "detail"
            );
          }

          // Beim Laden schauen, was gespeichert wurde
          document.addEventListener("DOMContentLoaded", () => {
            const saved = localStorage.getItem("library-mode");
            if (saved === "light") {
              document.body.classList.add("light-mode");
              document.getElementById("mode-toggle").textContent = "üåû";
            }

            // Kompaktansicht wiederherstellen
            const view = localStorage.getItem("library-view");
            if (view === "compact") {
              compactViewEnabled = false; // damit toggle korrekt funktioniert
              toggleViewMode();
            }
          });

          // Klick auf Cover √∂ffnet Detailbereich
          function showDetailModal(book) {
            const modal = document.getElementById("detail-modal");
            const content = document.getElementById("detail-modal-content");

            const index = library.indexOf(book);

            content.innerHTML = `
        <div style="text-align: center;">
          <h3 style="margin-bottom: 0.3rem;">${book.title}</h3>
          ${
            book.subtitle
              ? `<div style="font-size: 0.95rem; font-weight: normal; margin-bottom: 1rem;">${book.subtitle}</div>`
              : ""
          }
        </div>

        <div style="display: flex; gap: 1rem; justify-content: center; align-items: flex-start; flex-wrap: wrap;">
          <div style="flex: 1 1 250px; min-width: 220px;">
            <p><b>Autor:</b> ${(book.authors || []).join("; ")}</p>
            ${book.series ? `<p><b>Serie:</b> ${book.series}</p>` : ""}
            ${book.volume ? `<p><b>Band:</b> ${book.volume}</p>` : ""}
            ${book.category ? `<p><b>Kategorie:</b> ${book.category}</p>` : ""}
            ${book.genre ? `<p><b>Genre:</b> ${book.genre}</p>` : ""}
            ${book.pageCount ? `<p><b>Seiten:</b> ${book.pageCount}</p>` : ""}
            ${
              book.publishedDate
                ? `<p><b>Ver√∂ffentlicht:</b> ${book.publishedDate}</p>`
                : ""
            }
            ${book.isbn ? `<p><b>ISBN:</b> ${book.isbn}</p>` : ""}
            <p><b>Status:</b> <span style="color: ${
              book.read ? "#3feb57" : "#00bfff"
            };">
              ${book.read ? "üìó Gelesen" : "üÜï Ungelesen"}</span></p>
            ${
              book.rating
                ? `
              <p><b>Bewertung:</b>
              <span class="stars-display" title="${book.rating} von 5 Sternen">
                ${"‚òÖ".repeat(book.rating)}${"‚òÜ".repeat(5 - book.rating)}
              </span></p>`
                : ""
            }
            ${
              book.tags?.length
                ? `<p><b>Tags:</b> ${book.tags
                    .map((tag) => `<span class="tag">${tag}</span>`)
                    .join(" ")}</p>`
                : ""
            }
          </div>

          ${
            book.thumbnail
              ? `<img src="${book.thumbnail}" alt="Cover" style="height: 220px; border-radius: 5px;">`
              : ""
          }
        </div>

        ${
          book.description
            ? `<p style="margin-top:0.3rem;">${book.description}</p>`
            : ""
        }

        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
          <button onclick="editBook(${index}); closeDetailModal()">Bearbeiten</button>
          <button onclick="closeDetailModal()">Schlie√üen</button>
        </div>
      `;

            modal.classList.remove("hidden");
          }

          function closeDetailModal() {
            document.getElementById("detail-modal").classList.add("hidden");
          }
      
    </script>
  </body>
</html>
